import{A as e,f as s,j as a,v as t,d as l,o as r,c as n,a as o,Z as c,_ as u,h as i,u as v,B as d,m as p,z as g,aC as m,l as S,p as b,g as f,a6 as h}from"./chunk-Bpe8Il_K.js";import{_ as w}from"./chunk-CdEVcDFJ.js";import{u as y,I as k,h as W}from"./chunk-DpwHy-20.js";function x(e){return new Worker("/log-lottery/assets/timerworker.worker-CGfgERVo.js",{name:e?.name})}function _(){const{init:l,close:r}=function(s){let a=null;function t(){a?.terminate(),a=null}return e(()=>{t()}),{init:e=>{t(),a=new x,a.postMessage({interval:s}),a.onmessage||a.addEventListener("message",()=>e())},close:t}}(3e4),n=a(),o=a(),c=a(null);async function u(){if("serviceWorker"in navigator)try{c.value=await navigator.serviceWorker.register("/log-lottery/sw.js"),navigator.serviceWorker.addEventListener("message",e=>{switch(e.data.type){case"WS_STATUS":n.value=e.data.payload;break;case"WS_MESSAGE":{const s=e.data.payload;o.value={...s,id:t()};break}case"WS_ERROR":case"WS_CLOSE":n.value={status:WebSocket.CLOSED,connected:!1},r();break;case"WS_OPEN":n.value={status:WebSocket.OPEN,connected:!0},l(i)}})}catch(e){}}function i(){navigator.serviceWorker.ready.then(e=>{e.active?.postMessage({type:"GET_WS_STATUS"})})}return s(()=>{u(),i()}),{open:function(e){navigator.serviceWorker.ready.then(s=>{s.active?.postMessage({type:"CONNECT_WS",payload:{url:e}})})},close:function(){r(),navigator.serviceWorker.ready.then(e=>{e.active?.postMessage({type:"DISCONNECT_WS"})})},send:function(e){navigator.serviceWorker.ready.then(s=>{s.active?.postMessage({type:"SEND_WS_MESSAGE",payload:{message:e,id:t()}})})},status:n,data:o}}const C={class:"w-1/2 h-1/2 border rounded-md shadow-lg"},L={class:"chat chat-end"},E={class:"chat-header"},T={class:"text-xs opacity-50"},M={class:"chat-bubble break-all whitespace-normal"},j=l({__name:"MsgListContainer",props:{msgList:{}},setup:e=>(s,a)=>(r(),n("div",C,[o("ul",null,[(r(!0),n(c,null,u(e.msgList,e=>(r(),n("li",{key:e.id,class:"mb-3"},[o("div",L,[o("div",E,[o("time",T,i(e.dateTime),1)]),o("div",M,i(e.data),1)])]))),128))])]))}),N={class:"p-4 border text-setting fieldset bg-base-200 border-base-300 rounded-box w-xs pb-10"},O={class:"flex flex-row items-center form-control"},A={class:""},D={class:"label flex flex-col justify-start items-start"},G={class:"radio-group flex gap-9"},R={class:"flex gap-3"},I={for:"default-server"},U=["checked","onChange"],V=["disabled","value"],B={class:"flex flex-row items-center form-control"},F={class:"flex flex-col gap-3"},P={class:"flex gap-2 items-center"},q={class:"ws-status"},z={key:0},Z={key:1},$={key:2},H={key:3},J={class:"flex gap-3"},K=l({__name:"ServerSetting",props:p({serverList:{},wsStatus:{},openWs:{type:Function},closeWs:{type:Function}},{currentServer:{required:!0},currentServerModifiers:{}}),emits:["update:currentServer"],setup(e){const s=v(e,"currentServer"),t=a("");return d(()=>s.value?.id,(e,a)=>{e!==a&&(t.value=s.value?.host||"")},{immediate:!0}),d(t,e=>{s.value&&(s.value.host=e)}),t.value=s.value?.host||"",(a,l)=>(r(),n("fieldset",N,[l[9]||(l[9]=o("legend",{class:"fieldset-legend"}," 弹幕服务 ",-1)),o("label",O,[o("div",A,[o("div",D,[l[3]||(l[3]=o("label",{class:"label"},[o("span",{class:"label-text text-left"},"弹幕服务地址"),o("div",{class:"tooltip","data-tip":"改变弹幕服务地址后会断开连接"},[o("button",{class:"btn btn-circle h-4 hover:bg-base-300"}," ? ")])],-1)),o("div",G,[o("ul",R,[(r(!0),n(c,null,u(e.serverList,e=>(r(),n("li",{key:e.id,class:"flex flex-col"},[o("label",I,i(e.name),1),o("input",{id:"default-server",type:"radio",name:"radio-1",class:"radio",checked:s.value?.value===e.value,onChange:a=>s.value=e},null,40,U)]))),128))])]),o("input",{type:"text",placeholder:"请输入服务地址",disabled:"default"===s.value.value,class:"w-full max-w-xs input input-bordered",value:t.value,onInput:l[0]||(l[0]=e=>t.value=e.target.value)},null,40,V)])])]),o("label",B,[o("div",F,[l[8]||(l[8]=o("div",{class:"label"},[o("span",{class:"label-text"},"弹幕服务器连接状态")],-1)),o("div",P,[o("div",q,[e.wsStatus&&e.wsStatus.connected?(r(),n("div",z,[...l[4]||(l[4]=[o("div",{"aria-label":"success",class:"status status-success"},null,-1),o("span",null,"已连接",-1)])])):e.wsStatus&&!1===e.wsStatus.connected?(r(),n("div",Z,[...l[5]||(l[5]=[o("div",{"aria-label":"error",class:"status status-error"},null,-1),o("span",null,"已断开",-1)])])):e.wsStatus&&e.wsStatus.status?(r(),n("div",$,[...l[6]||(l[6]=[o("div",{"aria-label":"error",class:"status status-error"},null,-1),o("span",null,"操作中",-1)])])):(r(),n("div",H,[...l[7]||(l[7]=[o("div",{"aria-label":"warning",class:"status status-warning"},null,-1),o("span",null,"未连接",-1)])]))]),o("div",J,[!0===e.wsStatus?.connected?(r(),n("button",{key:0,class:"btn btn-error btn-sm",onClick:l[1]||(l[1]=(...s)=>e.closeWs&&e.closeWs(...s))},"断开")):(r(),n("button",{key:1,class:"btn btn-primary btn-sm",onClick:l[2]||(l[2]=(...s)=>e.openWs&&e.openWs(...s))},"连接"))])])])])]))}});function Q(){const e=y().serverConfig,{getServerList:t,getCurrentServer:l}=g(e),r=a(m(l.value)),n=a("ws://localhost:8080/echo"),o=a([]),{open:c,close:u,status:i}=_(),v=new k("msgList",["msgList"],1,["createTime"]);return d(()=>r.value.id,s=>{t.value.forEach(a=>{a.id===s&&(r.value=a,e.setCurrentServer(r.value))})}),d(()=>l.value.host,s=>{r.value.host=s,e.updateServerList(r.value)}),d(()=>i.value,s=>{!s||!0!==s.connected&&!1!==s.connected||e.setServerStatus(s.connected)}),s(()=>{(async()=>{v.getDataSortedByDateTime("msgList","dateTime").then(e=>{o.value=e})})()}),{serverList:t,currentServerValue:r,wsStatus:i,handleConnectWs:async()=>{const e=await W();n.value=`ws://localhost:8080/echo?userSignature=${e}`,c(n.value)},closeWs:u,msgList:o}}const X=l({__name:"index",setup(e){const{t:s}=S(),{serverList:a,currentServerValue:t,wsStatus:l,handleConnectWs:c,closeWs:u,msgList:i}=Q();return(e,v)=>(r(),n("div",null,[b(w,{title:f(s)("sidebar.server")},null,8,["title"]),o("div",null,[b(K,{"current-server":f(t),"onUpdate:currentServer":v[0]||(v[0]=e=>h(t)?t.value=e:null),"server-list":f(a),"ws-status":f(l),"open-ws":f(c),"close-ws":f(u)},null,8,["current-server","server-list","ws-status","open-ws","close-ws"]),b(j,{"msg-list":f(i)},null,8,["msg-list"])])]))}});export{X as default};
